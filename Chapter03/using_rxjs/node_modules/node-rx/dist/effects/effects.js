"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var merge_1 = require("rxjs/observable/merge");
var ignoreElements_1 = require("rxjs/operator/ignoreElements");
require("reflect-metadata"); // https://www.npmjs.com/package/reflect-metadata
var METADATA_KEY = '@node-rx/effects';
function Effect(_a) {
    var dispatch = (_a === void 0 ? { dispatch: true } : _a).dispatch;
    return function (target, propertyName) {
        if (!Reflect.hasOwnMetadata(METADATA_KEY, target)) {
            Reflect.defineMetadata(METADATA_KEY, [], target);
        }
        var effects = Reflect.getOwnMetadata(METADATA_KEY, target);
        var metadata = { propertyName: propertyName, dispatch: dispatch };
        Reflect.defineMetadata(METADATA_KEY, effects.concat([metadata]), target);
    };
}
exports.Effect = Effect;
function getEffectsMetadata(instance) {
    var target = Object.getPrototypeOf(instance);
    if (!Reflect.hasOwnMetadata(METADATA_KEY, target)) {
        return [];
    }
    return Reflect.getOwnMetadata(METADATA_KEY, target);
}
exports.getEffectsMetadata = getEffectsMetadata;
function mergeEffects(instance) {
    var observables = getEffectsMetadata(instance).map(function (_a) {
        var propertyName = _a.propertyName, dispatch = _a.dispatch;
        var observable = typeof instance[propertyName] === 'function' ?
            instance[propertyName]() : instance[propertyName];
        if (dispatch === false) {
            return ignoreElements_1.ignoreElements.call(observable);
        }
        return observable;
    });
    return merge_1.merge.apply(void 0, observables);
}
exports.mergeEffects = mergeEffects;
